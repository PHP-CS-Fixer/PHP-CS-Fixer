<?php

declare(strict_types=1);

/*
 * This file is part of PHP CS Fixer.
 *
 * (c) Fabien Potencier <fabien@symfony.com>
 *     Dariusz Rumiński <dariusz.ruminski@gmail.com>
 *
 * This source file is subject to the MIT license that is bundled
 * with this source code in the file LICENSE.
 */

namespace PhpCsFixer\Tests\Fixer\Phpdoc;

use PhpCsFixer\ConfigurationException\InvalidFixerConfigurationException;
use PhpCsFixer\Fixer\Phpdoc\PhpdocAlignFixer;
use PhpCsFixer\Tests\Test\AbstractFixerTestCase;
use PhpCsFixer\WhitespacesFixerConfig;

/**
 * @internal
 *
 * @covers \PhpCsFixer\Fixer\Phpdoc\PhpdocAlignFixer
 *
 * @extends AbstractFixerTestCase<\PhpCsFixer\Fixer\Phpdoc\PhpdocAlignFixer>
 *
 * @phpstan-import-type _AutogeneratedInputConfiguration from \PhpCsFixer\Fixer\Phpdoc\PhpdocAlignFixer
 *
 * @no-named-arguments Parameter names are not covered by the backward compatibility promise.
 */
final class PhpdocAlignFixerTest extends AbstractFixerTestCase
{
    /**
     * @dataProvider provideFixCases
     *
     * @param _AutogeneratedInputConfiguration $configuration
     */
    public function testFix(
        string $expected,
        ?string $input,
        array $configuration,
        ?WhitespacesFixerConfig $whitespacesFixerConfig = null
    ): void {
        $this->fixer->configure($configuration);
        if (null !== $whitespacesFixerConfig) {
            $this->fixer->setWhitespacesConfig($whitespacesFixerConfig);
        }

        $this->doTest($expected, $input);
    }

    /**
     * @return iterable<string, array{string, null|string, _AutogeneratedInputConfiguration, 3?: WhitespacesFixerConfig}>
     */
    public static function provideFixCases(): iterable
    {
        yield 'none, one and four spaces between type and variable' => [
            '<?php
                    /**
                     * @param int $a
                     * @param int $b
                     * @param int $c
                     */',
            '<?php
                    /**
                     * @param int    $a
                     * @param int $b
                     * @param int$c
                     */',
            ['tags' => ['param']],
        ];

        yield 'aligning params' => [
            '<?php
    /**
     * @param EngineInterface $templating
     * @param string          $format
     * @param int             $code       An HTTP response status code
     * @param bool            $debug
     * @param mixed           &$reference A parameter passed by reference
     */

',
            '<?php
    /**
     * @param  EngineInterface $templating
     * @param string      $format
     * @param  int  $code       An HTTP response status code
     * @param    bool         $debug
     * @param  mixed    &$reference     A parameter passed by reference
     */

',
            ['tags' => ['param']],
        ];

        yield 'left align' => [
            '<?php
    /**
     * @param EngineInterface $templating
     * @param string $format
     * @param int $code An HTTP response status code
     * @param bool $debug
     * @param mixed &$reference A parameter passed by reference
     */

',
            '<?php
    /**
     * @param  EngineInterface $templating
     * @param string      $format
     * @param  int  $code       An HTTP response status code
     * @param    bool         $debug
     * @param  mixed    &$reference     A parameter passed by reference
     */

',
            ['tags' => ['param'], 'align' => PhpdocAlignFixer::ALIGN_LEFT],
        ];

        yield 'partially untyped' => [
            '<?php
    /**
     * @param         $id
     * @param         $parentId
     * @param int     $websiteId
     * @param         $position
     * @param int[][] $siblings
     */

',
            '<?php
    /**
     * @param      $id
     * @param    $parentId
     * @param int $websiteId
     * @param        $position
     * @param int[][]  $siblings
     */

',
            ['tags' => ['param']],
        ];

        yield 'partially untyped left align' => [
            '<?php
    /**
     * @param $id
     * @param $parentId
     * @param int $websiteId
     * @param $position
     * @param int[][] $siblings
     */

',
            '<?php
    /**
     * @param      $id
     * @param    $parentId
     * @param int $websiteId
     * @param        $position
     * @param int[][]  $siblings
     */

',
            ['tags' => ['param'], 'align' => PhpdocAlignFixer::ALIGN_LEFT],
        ];

        yield 'multiline description' => [
            '<?php
    /**
     * @param    EngineInterface $templating
     * @param    string          $format
     * @param    int             $code       An HTTP response status code
     *                                       See constants
     * @param    bool            $debug
     * @param    bool            $debug      See constants
     *                                       See constants
     * @param    mixed           &$reference A parameter passed by reference
     * @property mixed           $foo        A foo
     *                                       See constants
     * @method   static          baz($bop)   A method that does a thing
     *                                       It does it well
     */

',
            '<?php
    /**
     * @param  EngineInterface $templating
     * @param string      $format
     * @param  int  $code       An HTTP response status code
     *                              See constants
     * @param    bool         $debug
     * @param    bool         $debug See constants
     * See constants
     * @param  mixed    &$reference     A parameter passed by reference
     * @property   mixed   $foo     A foo
     *                               See constants
     * @method static   baz($bop)   A method that does a thing
     *                          It does it well
     */

',
            ['tags' => ['param', 'property', 'method']],
        ];

        yield 'multiline description left align' => [
            '<?php
    /**
     * @param EngineInterface $templating
     * @param string $format
     * @param int $code An HTTP response status code
     *                  See constants
     * @param bool $debug
     * @param bool $debug See constants
     *                    See constants
     * @param mixed &$reference A parameter passed by reference
     * @property mixed $foo A foo
     *                      See constants
     * @method static baz($bop) A method that does a thing
     *                          It does it well
     */

',
            '<?php
    /**
     * @param  EngineInterface $templating
     * @param string      $format
     * @param  int  $code       An HTTP response status code
     *                              See constants
     * @param    bool         $debug
     * @param    bool         $debug See constants
     * See constants
     * @param  mixed    &$reference     A parameter passed by reference
     * @property   mixed   $foo     A foo
     *                               See constants
     * @method static   baz($bop)   A method that does a thing
     *                          It does it well
     */

',
            ['tags' => ['param', 'property', 'method'], 'align' => PhpdocAlignFixer::ALIGN_LEFT],
        ];

        yield 'multiline description with throws' => [
            '<?php
    /**
     * @param EngineInterface $templating
     * @param string          $format
     * @param int             $code       An HTTP response status code
     *                                    See constants
     * @param bool            $debug
     * @param bool            $debug      See constants
     *                                    See constants
     * @param mixed           &$reference A parameter passed by reference
     *
     * @return Foo description foo
     *
     * @throws Foo description foo
     *             description foo
     */

',
            '<?php
    /**
     * @param  EngineInterface $templating
     * @param string      $format
     * @param  int  $code       An HTTP response status code
     *                              See constants
     * @param    bool         $debug
     * @param    bool         $debug See constants
     * See constants
     * @param  mixed    &$reference     A parameter passed by reference
     *
     * @return Foo description foo
     *
     * @throws Foo             description foo
     * description foo
     */

',
            ['tags' => ['param', 'return', 'throws']],
        ];

        yield 'multiline description with throws left align' => [
            '<?php
    /**
     * @param EngineInterface $templating
     * @param string $format
     * @param int $code An HTTP response status code
     *                  See constants
     * @param bool $debug
     * @param bool $debug See constants
     *                    See constants
     * @param mixed &$reference A parameter passed by reference
     *
     * @return Foo description foo
     *
     * @throws Foo description foo
     *             description foo
     */

',
            '<?php
    /**
     * @param  EngineInterface $templating
     * @param string      $format
     * @param  int  $code       An HTTP response status code
     *                              See constants
     * @param    bool         $debug
     * @param    bool         $debug See constants
     * See constants
     * @param  mixed    &$reference     A parameter passed by reference
     *
     * @return Foo description foo
     *
     * @throws Foo             description foo
     * description foo
     */

',
            ['tags' => ['param', 'return', 'throws'], 'align' => PhpdocAlignFixer::ALIGN_LEFT],
        ];

        yield 'return and throws' => [
            '<?php
    /**
     * @param  EngineInterface $templating
     * @param  mixed           &$reference A parameter passed by reference
     *                                     Multiline description
     * @throws Bar             description bar
     * @return Foo             description foo
     *                         multiline description
     */

',
            '<?php
    /**
     * @param EngineInterface       $templating
     * @param  mixed    &$reference     A parameter passed by reference
     *                                  Multiline description
     * @throws   Bar description bar
     * @return  Foo     description foo
     *                  multiline description
     */

',
            ['tags' => ['param', 'throws', 'return']],
        ];

        // https://github.com/FriendsOfPhp/PHP-CS-Fixer/issues/55
        yield 'three params with return' => [
            '<?php
    /**
     * @param  string $param1
     * @param  bool   $param2 lorem ipsum
     * @param  string $param3 lorem ipsum
     * @return int    lorem ipsum
     */

',
            '<?php
    /**
     * @param   string $param1
     * @param bool   $param2 lorem ipsum
     * @param    string $param3 lorem ipsum
     * @return int lorem ipsum
     */

',
            ['tags' => ['param', 'return']],
        ];

        yield 'only return' => [
            '<?php
    /**
     * @return Foo description foo
     */

',
            '<?php
    /**
     * @return   Foo             description foo
     */

',
            ['tags' => ['return']],
        ];

        yield 'return with $this' => [
            '<?php
    /**
     * @param  Foo   $foo
     * @return $this
     */

',
            '<?php
    /**
     * @param Foo $foo
     * @return $this
     */

',
            ['tags' => ['param', 'return']],
        ];

        yield 'custom annotations stay untouched' => [
            '<?php
    /**
     * @return string
     * @SuppressWarnings(PHPMD.UnusedLocalVariable)
     */

',
            '<?php
    /**
     * @return string
     *  @SuppressWarnings(PHPMD.UnusedLocalVariable)
     */

',
            ['tags' => ['return']],
        ];

        yield 'custom annotations stay untouched 2' => [
            '<?php

class X
{
    /**
     * @var Collection<Value>|Value[]
     * @ORM\ManyToMany(
     *  targetEntity="\Dl\Component\DomainModel\Product\Value\AbstractValue",
     *  inversedBy="externalAliases"
     * )
     */
    private $values;
}

',
            null,
            ['tags' => ['var']],
        ];

        yield 'left align 2' => [
            '<?php
    /**
     * @param int $a
     * @param string $b
     *
     * @dataProvider     dataJobCreation
     */

',
            '<?php
    /**
     * @param     int       $a
     * @param     string    $b
     *
     * @dataProvider     dataJobCreation
     */

',
            ['tags' => ['param'], 'align' => PhpdocAlignFixer::ALIGN_LEFT],
        ];

        yield 'params and data provider' => [
            '<?php
    /**
     * @param int         $a
     * @param string|null $b
     *
     * @dataProvider   dataJobCreation
     */

',
            '<?php
    /**
     * @param     int       $a
     * @param     string|null    $b
     *
     * @dataProvider   dataJobCreation
     */

',
            ['tags' => ['param']],
        ];

        yield 'var' => [
            '<?php
    /**
     * @var Type
     */

',
            '<?php
    /**
     * @var   Type
     */

',
            ['tags' => ['var']],
        ];

        yield 'type' => [
            '<?php
    /**
     * @type Type
     */

',
            '<?php
    /**
     * @type   Type
     */

',
            ['tags' => ['type']],
        ];

        yield 'var and description' => [
            '<?php
    /**
     * This is a variable.
     *
     * @var Type
     */

',
            '<?php
    /**
     * This is a variable.
     *
     * @var   Type
     */

',
            ['tags' => ['var']],
        ];

        yield 'var and inline description' => [
            '<?php
    /**
     * @var Type This is a variable.
     */

',
            '<?php
    /**
     * @var   Type   This is a variable.
     */

',
            ['tags' => ['var']],
        ];

        yield 'type and inline description' => [
            '<?php
    /**
     * @type Type This is a variable.
     */

',
            '<?php
    /**
     * @type   Type   This is a variable.
     */

',
            ['tags' => ['type']],
        ];

        yield 'when we are not modifying a docblock, then line endings should not change' => [
            "<?php\r    /**\r     * @param Example Hello there!\r     */\r",
            null,
            ['tags' => ['param']],
        ];

        yield 'malformed doc block' => [
            '<?php
    /**
     * @return string
     * */

',
            null,
            ['tags' => ['return']],
        ];

        yield 'different indentation' => [
            '<?php
/**
 * @param int    $limit
 * @param string $more
 *
 * @return array
 */

        /**
         * @param int    $limit
         * @param string $more
         *
         * @return array
         */
',
            '<?php
/**
 * @param   int       $limit
 * @param   string       $more
 *
 * @return array
 */

        /**
         * @param   int       $limit
         * @param   string       $more
         *
         * @return array
         */
',
            ['tags' => ['param', 'return']],
        ];

        yield 'different indentation left align' => [
            '<?php
/**
 * @param int $limit
 * @param string $more
 *
 * @return array
 */

        /**
         * @param int $limit
         * @param string $more
         *
         * @return array
         */
',
            '<?php
/**
 * @param   int       $limit
 * @param   string       $more
 *
 * @return array
 */

        /**
         * @param   int       $limit
         * @param   string       $more
         *
         * @return array
         */
',
            ['tags' => ['param', 'return'], 'align' => PhpdocAlignFixer::ALIGN_LEFT],
        ];

        yield 'messy whitespaces 1' => [
            "<?php\r\n\t/**\r\n\t * @type Type This is a variable.\r\n\t */",
            "<?php\r\n\t/**\r\n\t * @type   Type   This is a variable.\r\n\t */",
            ['tags' => ['type']],
            new WhitespacesFixerConfig("\t", "\r\n"),
        ];

        yield 'messy whitespaces 2' => [
            "<?php\r\n/**\r\n * @param int    \$limit\r\n * @param string \$more\r\n *\r\n * @return array\r\n */",
            "<?php\r\n/**\r\n * @param   int       \$limit\r\n * @param   string       \$more\r\n *\r\n * @return array\r\n */",
            ['tags' => ['param', 'return']],
            new WhitespacesFixerConfig("\t", "\r\n"),
        ];

        yield 'messy whitespaces 3' => [
            "<?php\r\n/**\r\n * @param int    \$limit\r\n * @param string \$more\r\n *\r\n * @return array\r\n */",
            "<?php\r\n/**\r\n * @param   int       \$limit\r\n * @param   string       \$more\r\n *\r\n * @return array\r\n */",
            [],
            new WhitespacesFixerConfig("\t", "\r\n"),
        ];

        yield 'messy whitespaces 4' => [
            "<?php\n/**\n * @param int \$a\n * @param int \$b\n *               ABC\n */",
            "<?php\n/**\n * @param    int \$a\n * @param    int   \$b\n * ABC\n */",
            [],
            new WhitespacesFixerConfig('    ', "\n"),
        ];

        yield 'messy whitespaces 5' => [
            "<?php\r\n/**\r\n * @param int \$z\r\n * @param int \$b\r\n *               XYZ\r\n */",
            "<?php\r\n/**\r\n * @param    int \$z\r\n * @param    int   \$b\r\n * XYZ\r\n */",
            [],
            new WhitespacesFixerConfig('    ', "\r\n"),
        ];

        yield 'badly formatted' => [
            "<?php\n    /**\n     * @var Foo */\n",
            null,
            ['tags' => ['var']],
        ];

        yield 'unicode' => [
            '<?php
    /**
     * Method test.
     *
     * @param int      $foobar Description
     * @param string   $foo    Description
     * @param mixed    $bar    Description word_with_ą
     * @param int|null $test   Description
     */
    $a = 1;

    /**
     * @return string
     * @SuppressWarnings(PHPMD.UnusedLocalVariable) word_with_ą
     */
    $b = 1;
',
            '<?php
    /**
     * Method test.
     *
     * @param int    $foobar Description
     * @param string $foo    Description
     * @param mixed $bar Description word_with_ą
     * @param int|null $test Description
     */
    $a = 1;

    /**
     * @return string
     *   @SuppressWarnings(PHPMD.UnusedLocalVariable) word_with_ą
     */
    $b = 1;
',
            ['tags' => ['param', 'return']],
        ];

        yield 'does align property by default' => [
            '<?php
    /**
     * @param    int       $foobar Description
     * @return   int
     * @throws   Exception
     * @var      FooBar
     * @type     BarFoo
     * @property string    $foo    Hello World
     */
',
            '<?php
    /**
     * @param    int   $foobar   Description
     * @return  int
     * @throws Exception
     * @var       FooBar
     * @type      BarFoo
     * @property     string    $foo   Hello World
     */
',
            [],
        ];

        yield 'aligns property' => [
            '<?php
    /**
     * @param    int       $foobar Description
     * @return   int
     * @throws   Exception
     * @var      FooBar
     * @type     BarFoo
     * @property string    $foo    Hello World
     */
',
            '<?php
    /**
     * @param    int   $foobar   Description
     * @return  int
     * @throws Exception
     * @var       FooBar
     * @type      BarFoo
     * @property     string    $foo   Hello World
     */
',
            ['tags' => ['param', 'property', 'return', 'throws', 'type', 'var']],
        ];

        yield 'does align method by default' => [
            '<?php
    /**
     * @param  int       $foobar          Description
     * @return int
     * @throws Exception
     * @var    FooBar
     * @type   BarFoo
     * @method string    foo(string $bar) Hello World
     */
',
            '<?php
    /**
     * @param    int   $foobar   Description
     * @return  int
     * @throws Exception
     * @var       FooBar
     * @type      BarFoo
     * @method     string    foo(string $bar)   Hello World
     */
',
            [],
        ];

        yield 'aligns method' => [
            '<?php
    /**
     * @param  int       $foobar                                        Description
     * @return int
     * @throws Exception
     * @var    FooBar
     * @type   BarFoo
     * @method int       foo(string $bar, string ...$things, int &$baz) Description
     */
',
            '<?php
    /**
     * @param    int   $foobar     Description
     * @return  int
     * @throws Exception
     * @var       FooBar
     * @type      BarFoo
     * @method        int    foo(string $bar, string ...$things, int &$baz)   Description
     */
',
            ['tags' => ['param', 'method', 'return', 'throws', 'type', 'var']],
        ];

        yield 'aligns method without parameters' => [
            '<?php
    /**
     * @property string $foo  Desc
     * @method   int    foo() Description
     */
',
            '<?php
    /**
     * @property    string   $foo     Desc
     * @method int      foo()          Description
     */
',
            ['tags' => ['method', 'property']],
        ];

        yield 'aligns method without parameters left align' => [
            '<?php
    /**
     * @property string $foo Desc
     * @method int foo() Description
     */
',
            '<?php
    /**
     * @property    string   $foo     Desc
     * @method int      foo()          Description
     */
',
            ['tags' => ['method', 'property'], 'align' => PhpdocAlignFixer::ALIGN_LEFT],
        ];

        yield 'does not format method' => [
            '<?php
    /**
     * @method int foo( string  $bar ) Description
     */
',
            null,
            ['tags' => ['method']],
        ];

        yield 'aligns method without return type' => [
            '<?php
    /**
     * @property string $foo  Desc
     * @method   int    foo() Description
     * @method          bar() Descrip
     */
',
            '<?php
    /**
     * @property    string   $foo     Desc
     * @method int      foo()          Description
     * @method    bar()   Descrip
     */
',
            ['tags' => ['method', 'property']],
        ];

        yield 'aligns methods without return type' => [
            '<?php
    /**
     * @method fooBaz()         Description
     * @method bar(string $foo) Descrip
     */
',
            '<?php
    /**
     * @method         fooBaz()  Description
     * @method    bar(string $foo)   Descrip
     */
',
            ['tags' => ['method']],
        ];

        yield 'aligns static and non-static methods' => [
            '<?php
    /**
     * @property        string      $foo             Desc1
     * @property        int         $bar             Desc2
     * @method                      foo(string $foo) DescriptionFoo
     * @method          static      bar(string $foo) DescriptionBar
     * @method          string|null baz(bool $baz)   DescriptionBaz
     * @method   static int|false   qux(float $qux)  DescriptionQux
     * @method   static static      quux(int $quux)  DescriptionQuux
     * @method   static $this       quuz(bool $quuz) DescriptionQuuz
     */
',
            '<?php
    /**
     * @property    string   $foo     Desc1
     * @property  int   $bar   Desc2
     * @method     foo(string $foo)    DescriptionFoo
     * @method  static     bar(string $foo) DescriptionBar
     * @method    string|null    baz(bool $baz)  DescriptionBaz
     * @method static     int|false qux(float $qux) DescriptionQux
     * @method static   static    quux(int $quux) DescriptionQuux
     * @method static  $this     quuz(bool $quuz) DescriptionQuuz
     */
',
            ['tags' => ['method', 'property']],
        ];

        yield 'aligns static and non-static methods left align' => [
            '<?php
    /**
     * @property string $foo Desc1
     * @property int $bar Desc2
     * @method foo(string $foo) DescriptionFoo
     * @method static bar(string $foo) DescriptionBar
     * @method string|null baz(bool $baz) DescriptionBaz
     * @method static int|false qux(float $qux) DescriptionQux
     * @method static static quux(int $quux) DescriptionQuux
     * @method static $this quuz(bool $quuz) DescriptionQuuz
     */
',
            '<?php
    /**
     * @property    string   $foo     Desc1
     * @property  int   $bar   Desc2
     * @method     foo(string $foo)    DescriptionFoo
     * @method  static     bar(string $foo) DescriptionBar
     * @method    string|null    baz(bool $baz)  DescriptionBaz
     * @method static     int|false qux(float $qux) DescriptionQux
     * @method static   static    quux(int $quux) DescriptionQuux
     * @method static  $this     quuz(bool $quuz) DescriptionQuuz
     */
',
            ['tags' => ['method', 'property'], 'align' => PhpdocAlignFixer::ALIGN_LEFT],
        ];

        yield 'aligns return static' => [
            '<?php
    /**
     * @param  string    $foobar Desc1
     * @param  int       &$baz   Desc2
     * @param  ?Qux      $qux    Desc3
     * @param  int|float $quux   Desc4
     * @return static    DescriptionReturn
     * @throws Exception DescriptionException
     */
',
            '<?php
    /**
     * @param    string   $foobar     Desc1
     * @param  int   &$baz   Desc2
     * @param ?Qux       $qux   Desc3
     * @param    int|float $quux   Desc4
     * @return  static     DescriptionReturn
     * @throws   Exception       DescriptionException
     */
',
            ['tags' => ['param', 'return', 'throws']],
        ];

        yield 'aligns return static left align' => [
            '<?php
    /**
     * @param string $foobar Desc1
     * @param int &$baz Desc2
     * @param ?Qux $qux Desc3
     * @param int|float $quux Desc4
     * @return static DescriptionReturn
     * @throws Exception DescriptionException
     */
',
            '<?php
    /**
     * @param    string   $foobar     Desc1
     * @param  int   &$baz   Desc2
     * @param ?Qux       $qux   Desc3
     * @param    int|float $quux   Desc4
     * @return  static     DescriptionReturn
     * @throws   Exception       DescriptionException
     */
',
            ['tags' => ['param', 'return', 'throws'], 'align' => PhpdocAlignFixer::ALIGN_LEFT],
        ];

        yield 'does not align with empty config' => [
            '<?php
    /**
     * @param    int   $foobar   Description
     * @return  int
     * @throws Exception
     * @var       FooBar
     * @type      BarFoo
     * @property     string    $foo   Hello World
     * @method    int    bar() Description
     */
',
            null,
            ['tags' => []],
        ];

        yield 'variadic params 1' => [
            '<?php
final class Sample
{
    /**
     * @param int[] $a    A
     * @param int   &$b   B
     * @param array ...$c C
     */
    public function sample2($a, &$b, ...$c)
    {
    }
}
',
            '<?php
final class Sample
{
    /**
     * @param int[]       $a  A
     * @param int          &$b B
     * @param array ...$c    C
     */
    public function sample2($a, &$b, ...$c)
    {
    }
}
',
            ['tags' => ['param']],
        ];

        yield 'variadic params 2' => [
            '<?php
final class Sample
{
    /**
     * @param int     $a
     * @param int     $b
     * @param array[] ...$c
     */
    public function sample2($a, $b, ...$c)
    {
    }
}
',
            '<?php
final class Sample
{
    /**
     * @param int       $a
     * @param int    $b
     * @param array[]      ...$c
     */
    public function sample2($a, $b, ...$c)
    {
    }
}
',
            ['tags' => ['param']],
        ];

        yield 'variadic params 3' => [
            '<?php
final class Sample
{
    /**
     * @param int $a
     * @param int $b
     * @param array[] ...$c
     */
    public function sample2($a, $b, ...$c)
    {
    }
}
',
            '<?php
final class Sample
{
    /**
     * @param int       $a
     * @param int    $b
     * @param array[]      ...$c
     */
    public function sample2($a, $b, ...$c)
    {
    }
}
',
            ['tags' => ['param'], 'align' => PhpdocAlignFixer::ALIGN_LEFT],
        ];

        yield 'variadic params 4' => [
            '<?php
/**
 * @property       string $myMagicProperty      magic property
 * @property-read  string $myMagicReadProperty  magic read-only property
 * @property-write string $myMagicWriteProperty magic write-only property
 */
class Foo {}
',
            '<?php
/**
 * @property string $myMagicProperty magic property
 * @property-read string $myMagicReadProperty magic read-only property
 * @property-write string $myMagicWriteProperty magic write-only property
 */
class Foo {}
',
            ['tags' => ['property', 'property-read', 'property-write']],
        ];

        yield 'invalid PHPDoc 1' => [
            '<?php
/**
 * @ Security("is_granted(\'CANCEL\', giftCard)")
 */
 ',
            null,
            ['tags' => ['param', 'return', 'throws', 'type', 'var']],
        ];

        yield 'invalid PHPDoc 2' => [
            '<?php
/**
 * @ Security("is_granted(\'CANCEL\', giftCard)")
 */
 ',
            null,
            ['tags' => ['param', 'return', 'throws', 'type', 'var', 'method']],
        ];

        yield 'invalid PHPDoc 3' => [
            '<?php
/**
 * @ Security("is_granted(\'CANCEL\', giftCard)")
 * @     foo   bar
 *   @ foo
 */
 ',
            null,
            ['tags' => ['param', 'return', 'throws', 'type', 'var']],
        ];

        yield 'types containing callables' => [
            '<?php
            /**
             * @param callable(Foo): Bar       $x  Description
             * @param callable(FooFoo): BarBar $yy Description
             */
            ',
            '<?php
            /**
             * @param callable(Foo): Bar $x Description
             * @param callable(FooFoo): BarBar $yy Description
             */
            ',
            [],
        ];

        yield 'types containing whitespace' => [
            '<?php
            /**
             * @var int                   $key
             * @var iterable<int, string> $value
             */
            /**
             * @param array<int, $this>    $arrayOfIntegers
             * @param array<string, $this> $arrayOfStrings
             */
        ',
            null,
            [],
        ];

        yield 'closure types containing backslash' => [
            '<?php
            /**
             * @var string                              $input
             * @var \Closure                            $fn
             * @var \Closure(bool):int                  $fn2
             * @var Closure                             $fn3
             * @var Closure(string):string              $fn4
             * @var array<string, array<string, mixed>> $data
             */
            /**
             * @param string                              $input
             * @param \Closure                            $fn
             * @param \Closure(bool):int                  $fn2
             * @param Closure                             $fn3
             * @param Closure(string):string              $fn4
             * @param array<string, array<string, mixed>> $data
             */
            /**
             * @var string                   $value
             * @var \Closure(string): string $callback
             * @var Closure(int): bool       $callback2
             */
            /**
             * @param string                   $value
             * @param \Closure(string): string $callback
             * @param Closure(int): bool       $callback2
             */
            /**
             * @var Closure(array<int, bool>): bool $callback1
             * @var \Closure(string): string        $callback2
             */
            /**
             * @param Closure(array<int, bool>): bool $callback1
             * @param \Closure(string): string        $callback2
             */
        ',
            null,
            [],
        ];

        yield 'types parenthesized' => [
            '<?php
            /**
             * @param list<string>                                   $allowedTypes
             * @param null|list<\Closure(mixed): (bool|null|scalar)> $allowedValues
             */
            ',
            '<?php
            /**
             * @param list<string> $allowedTypes
             * @param null|list<\Closure(mixed): (bool|null|scalar)> $allowedValues
             */
            ',
            [],
        ];

        yield 'callable types with ugly code 1' => [
            '<?php
        /**
         * @var callable                      $fn
         * @var callable(bool): int           $fn2
         * @var Closure                       $fn3
         * @var Closure(string|object):string $fn4
         * @var \Closure                      $fn5
         * @var \Closure(int, bool): bool     $fn6
         */
        ',
            '<?php
        /**
         * @var callable $fn
         * @var callable(bool): int $fn2
         * @var Closure $fn3
         * @var Closure(string|object):string $fn4
         * @var \Closure $fn5
         * @var \Closure(int, bool): bool $fn6
         */
        ',
            [],
        ];

        yield 'callable types with ugly code 2' => [
            '<?php
        /**
         * @var callable                      $fn
         * @var callable(bool): int           $fn2
         * @var Closure                       $fn3
         * @var Closure(string|object):string $fn4
         * @var \Closure                      $fn5
         * @var \Closure(int, bool): bool     $fn6
         */
        ',
            '<?php
        /**
         * @var          callable           $fn
         * @var   callable(bool): int     $fn2
         * @var   Closure          $fn3
         * @var Closure(string|object):string                  $fn4
         * @var      \Closure             $fn5
         * @var            \Closure(int, bool): bool       $fn6
         */
        ',
            [],
        ];

        yield 'CUSTOM tags' => [
            '<?php
    /**
     * @param         EngineInterface $templating
     * @param         string          $format
     * @xxx-xxxxxxxxx int             $code       An HTTP response status code
     * @param         bool            $debug
     * @param         mixed           &$reference A parameter passed by reference
     */

',
            '<?php
    /**
     * @param  EngineInterface $templating
     * @param string      $format
     * @xxx-xxxxxxxxx  int  $code       An HTTP response status code
     * @param    bool         $debug
     * @param  mixed    &$reference     A parameter passed by reference
     */

',
            ['tags' => ['param', 'xxx-xxxxxxxxx']],
        ];

        yield 'no/2+ spaces after comment star' => [
            '<?php
/**
 * @property string $age  @Atk4\Field()
 * @property string $city @Atk4\Field()
 */
',
            '<?php
/**
 *  @property string $age           @Atk4\Field()
*@property    string $city          @Atk4\Field()
 */
',
            [],
        ];

        yield 'untyped param with multiline desc' => [
            '<?php
/**
 * @param $typeless Foo.
 *                  Bar.
 */
function foo($typeless): void {}',
            '<?php
/**
 * @param $typeless    Foo.
 *                     Bar.
 */
function foo($typeless): void {}',
            [],
        ];

        yield 'left align and @param with 2 spaces' => [
            '<?php
    /**
     * @param  EngineInterface  $templating
     * @param  string  $format
     * @param  int  $code  An HTTP response status code
     *                     See constants
     * @param  bool  $debug
     * @param  bool  $debug  See constants
     *                       See constants
     * @param  mixed  &$reference  A parameter passed by reference
     *
     * @return Foo description foo
     *
     * @throws Foo description foo
     *             description foo
     *
     */
',
            '<?php
    /**
     * @param  EngineInterface $templating
     * @param string      $format
     * @param  int  $code       An HTTP response status code
     *                              See constants
     * @param    bool         $debug
     * @param    bool         $debug See constants
     * See constants
     * @param  mixed    &$reference     A parameter passed by reference
     *
     * @return Foo description foo
     *
     * @throws Foo             description foo
     *             description foo
     *
     */
',
            [
                'align' => PhpdocAlignFixer::ALIGN_LEFT,
                'spacing' => ['param' => 2],
            ],
        ];

        yield 'vertical align with various spacing' => [
            '<?php
    /**
     * @param  EngineInterface  $templating
     * @param  string           $format
     * @param  int              $code        An HTTP response status code
     *                                       See constants
     * @param  bool             $debug
     * @param  bool             $debug       See constants
     *                                       See constants
     * @param  mixed            &$reference  A parameter passed by reference
     *
     * @return    Foo    description foo bar hello world!
     *                   return description continuation
     *
     * @throws Foo description foo
     *             description foo
     *
     */
',
            '<?php
    /**
     * @param  EngineInterface $templating
     * @param string      $format
     * @param  int  $code       An HTTP response status code
     *                              See constants
     * @param    bool         $debug
     * @param    bool         $debug See constants
     * See constants
     * @param  mixed    &$reference     A parameter passed by reference
     *
     * @return Foo description foo bar hello world!
    *        return description continuation
     *
     * @throws Foo             description foo
     *             description foo
     *
     */
',
            [
                'align' => PhpdocAlignFixer::ALIGN_VERTICAL,
                'spacing' => ['param' => 2, 'return' => 4],
            ],
        ];

        yield 'left align with various spacing' => [
            '<?php
    /**
     * @param  EngineInterface  $templating
     * @param  string  $format
     * @param  int  $code  An HTTP response status code
     *                     See constants
     * @param  bool  $debug
     * @param  bool  $debug  See constants
     *                       See constants
     * @param  mixed  &$reference  A parameter passed by reference
     *
     * @return    Foo    description foo
     *
     * @throws Foo description foo
     *             description foo
     *
     */
',
            '<?php
    /**
     * @param  EngineInterface $templating
     * @param string      $format
     * @param  int  $code       An HTTP response status code
     *                              See constants
     * @param    bool         $debug
     * @param    bool         $debug See constants
     * See constants
     * @param  mixed    &$reference     A parameter passed by reference
     *
     * @return Foo description foo
     *
     * @throws Foo             description foo
     *             description foo
     *
     */
',
            [
                'align' => PhpdocAlignFixer::ALIGN_LEFT,
                'spacing' => ['param' => 2, 'return' => 4],
            ],
        ];

        yield 'left align with changed default spacing' => [
            '<?php
    /**
     * @property  string  $bar  Foo-Bar lorem ipsum
     * @param  EngineInterface  $templating
     * @param  string  $format
     * @param  int  $code  An HTTP response status code
     *                     See constants
     * @param  bool  $debug
     * @param  bool  $debug  See constants
     *                       See constants
     * @param  mixed  &$reference  A parameter passed by reference
     *
     * @return    Foo    description foo
     *
     * @throws  Foo  description foo
     *               description foo
     *
     */
',
            '<?php
    /**
     * @property string $bar                    Foo-Bar lorem ipsum
     * @param  EngineInterface $templating
     * @param string      $format
     * @param  int  $code       An HTTP response status code
     *                              See constants
     * @param    bool         $debug
     * @param    bool         $debug See constants
     * See constants
     * @param  mixed    &$reference     A parameter passed by reference
     *
     * @return Foo description foo
     *
     * @throws Foo             description foo
     *             description foo
     *
     */
',
            [
                'align' => PhpdocAlignFixer::ALIGN_LEFT,
                'spacing' => ['_default' => 2, 'return' => 4],
            ],
        ];

        yield 'type with UTF8 characters' => [
            <<<'PHP'
                <?php
                /**
                 * @param Foooooooooooooooo $x
                 * @param Bar‹Baz›          $y
                 */
                PHP,
            <<<'PHP'
                <?php
                /**
                 * @param Foooooooooooooooo $x
                 * @param Bar‹Baz› $y
                 */
                PHP,
            ['tags' => ['param'], 'align' => PhpdocAlignFixer::ALIGN_VERTICAL],
        ];

        yield 'call-site generic variance' => [
            <<<'PHP'
                <?php
                /**
                 * @param Foo                                   $a
                 * @param Bar<covariant A, covariant B>         $b
                 * @param Foo                                   $c
                 * @param Bar<contravariant C, contravariant D> $d
                 * @param Foo                                   $e
                 */
                PHP,
            <<<'PHP'
                <?php
                /**
                 * @param Foo $a
                 * @param Bar<covariant A, covariant B> $b
                 * @param Foo $c
                 * @param Bar<contravariant C, contravariant D> $d
                 * @param Foo $e
                 */
                PHP,
            ['tags' => ['param'], 'align' => PhpdocAlignFixer::ALIGN_VERTICAL],
        ];
    }

    /**
     * @dataProvider provideInvalidConfigurationCases
     *
     * @param array<string, mixed> $config
     */
    public function testInvalidConfiguration(array $config, string $expectedMessage): void
    {
        $this->expectException(InvalidFixerConfigurationException::class);
        $this->expectExceptionMessage($expectedMessage);

        $this->fixer->configure($config);
    }

    /**
     * @return iterable<string, array{array<string, mixed>, string}>
     */
    public static function provideInvalidConfigurationCases(): iterable
    {
        yield 'zero' => [
            ['spacing' => 0],
            'The option "spacing" is invalid. All spacings must be greater than zero.',
        ];

        yield 'negative' => [
            ['spacing' => -2],
            'The option "spacing" is invalid. All spacings must be greater than zero.',
        ];

        yield 'zeroInArray' => [
            ['spacing' => ['param' => 1, 'return' => 0]],
            'The option "spacing" is invalid. All spacings must be greater than zero.',
        ];

        yield 'negativeInArray' => [
            [
                'align' => PhpdocAlignFixer::ALIGN_LEFT,
                'spacing' => ['return' => 2, 'param' => -1],
            ],
            'The option "spacing" is invalid. All spacings must be greater than zero.',
        ];
    }
}
