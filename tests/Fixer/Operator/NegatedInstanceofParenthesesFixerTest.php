<?php

declare(strict_types=1);

/*
 * This file is part of PHP CS Fixer.
 *
 * (c) Fabien Potencier <fabien@symfony.com>
 *     Dariusz Rumiński <dariusz.ruminski@gmail.com>
 *
 * This source file is subject to the MIT license that is bundled
 * with this source code in the file LICENSE.
 */

namespace PhpCsFixer\Tests\Fixer\Operator;

use PhpCsFixer\Tests\Test\AbstractFixerTestCase;

/**
 * @internal
 *
 * @covers \PhpCsFixer\Fixer\Operator\NegatedInstanceofParenthesesFixer
 *
 * @extends AbstractFixerTestCase<\PhpCsFixer\Fixer\Operator\NegatedInstanceofParenthesesFixer>
 *
 * @author Jérôme Gamez <jerome@gamez.name>
 *
 * @phpstan-import-type _AutogeneratedInputConfiguration from \PhpCsFixer\Fixer\Operator\NegatedInstanceofParenthesesFixer
 *
 * @no-named-arguments Parameter names are not covered by the backward compatibility promise.
 */
final class NegatedInstanceofParenthesesFixerTest extends AbstractFixerTestCase
{
    /**
     * @dataProvider provideFixCases
     */
    public function testFix(string $expected, ?string $input = null): void
    {
        $this->fixer->configure(['use_parentheses' => false]);
        $this->doTest($expected, $input);

        if (null !== $input) {
            $this->fixer->configure(['use_parentheses' => true]);
            $this->doTest($input, $expected);
        }
    }

    /**
     * @return iterable<string, array{0: string, 1?: string}>
     */
    public static function provideFixCases(): iterable
    {
        yield 'default' => [
            '<?php !$x instanceof Foo;',
        ];

        yield 'simple' => [
            '<?php !$x instanceof Foo;',
            '<?php !($x instanceof Foo);',
        ];

        yield 'fqn' => [
            '<?php !$x instanceof \A\B\C;',
            '<?php !($x instanceof \A\B\C);',
        ];

        yield 'relative' => [
            '<?php !$x instanceof namespace\Foo;',
            '<?php !($x instanceof namespace\Foo);',
        ];

        yield 'self' => [
            '<?php !$x instanceof self;',
            '<?php !($x instanceof self);',
        ];

        yield 'static' => [
            '<?php !$x instanceof static;',
            '<?php !($x instanceof static);',
        ];

        yield 'parent' => [
            '<?php !$x instanceof parent;',
            '<?php !($x instanceof parent);',
        ];

        yield 'negated_and_negated' => [
            '<?php !$x instanceof Foo && !$y instanceof Bar;',
            '<?php !($x instanceof Foo) && !($y instanceof Bar);',
        ];

        yield 'negated_and_unnegated' => [
            '<?php !$x instanceof Foo && $y instanceof Bar;',
            '<?php !($x instanceof Foo) && $y instanceof Bar;',
        ];

        yield 'nested_multiple' => [
            '<?php !(!$x instanceof Foo && !$y instanceof Bar);',
            '<?php !(!($x instanceof Foo) && !($y instanceof Bar));',
        ];

        yield 'double_wrapped' => [
            '<?php ((!$x instanceof Foo && !$y instanceof Bar));',
            '<?php ((!($x instanceof Foo) && !($y instanceof Bar)));',
        ];

        yield 'array_access' => [
            '<?php !$array[$key] instanceof Foo;',
            '<?php !($array[$key] instanceof Foo);',
        ];

        yield 'property_access' => [
            '<?php !$obj->prop instanceof Foo;',
            '<?php !($obj->prop instanceof Foo);',
        ];

        yield 'method_call' => [
            '<?php !$obj->method()->prop instanceof Foo;',
            '<?php !($obj->method()->prop instanceof Foo);',
        ];

        yield 'function_call' => [
            '<?php !foo() instanceof Foo;',
            '<?php !(foo() instanceof Foo);',
        ];

        yield 'same' => [
            '<?php !$a instanceof $a;',
            '<?php !($a instanceof $a);',
        ];

        yield 'self_static_property_access' => [
            '<?php !self::$x instanceof Foo;',
            '<?php !(self::$x instanceof Foo);',
        ];

        yield 'static_static_property_access' => [
            '<?php !static::$x instanceof Foo;',
            '<?php !(static::$x instanceof Foo);',
        ];

        yield 'parent_static_property_access' => [
            '<?php !parent::$x instanceof Foo;',
            '<?php !(parent::$x instanceof Foo);',
        ];

        yield 'wrapped_in_comments' => [
            '<?php !/*comment-1*/$x instanceof Foo/**comment-2*/;',
            '<?php !(/*comment-1*/$x instanceof Foo/**comment-2*/);',
        ];

        yield 'multiple_wrapped_in_comments' => [
            <<<'EXPR'
                <?php
                    if (
                        !/*comment-1*/$x instanceof Foo/**comment-2*/ ||
                        !/*comment-3*/$y instanceof Foo/**comment-4*/
                        && !/*comment-5*/$y instanceof Foo///comment-6
                    ) {}
                EXPR,
            <<<'EXPR'
                <?php
                    if (
                        !(/*comment-1*/$x instanceof Foo/**comment-2*/) ||
                        !(/*comment-3*/$y instanceof Foo/**comment-4*/)
                        && !(/*comment-5*/$y instanceof Foo///comment-6
                    )) {}
                EXPR,
        ];

        yield 'ternary_inside_function_call' => [
            '<?php var_dump(!(isset($b) ? $b : $a) instanceof SplFixedArray);',
            '<?php var_dump(!((isset($b) ? $b : $a) instanceof SplFixedArray));',
        ];
    }
}
